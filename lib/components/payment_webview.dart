import 'package:flutter/material.dart';
import 'package:qr_flutter/qr_flutter.dart'; // QR ÏΩîÎìú Ìå®ÌÇ§ÏßÄ Ï∂îÍ∞Ä
import 'package:url_launcher/url_launcher.dart'; // Ïô∏Î∂Ä Ïï± Ìò∏Ï∂úÏö©
import 'dart:convert';
import 'package:http/http.dart' as http;

class PaymentWebView extends StatefulWidget {
  final String name;
  final int amount;
  final String buyerEmail;
  final String buyerName;

  const PaymentWebView({
    Key? key,
    required this.name,
    required this.amount,
    required this.buyerEmail,
    required this.buyerName,
  }) : super(key: key);

  @override
  _PaymentWebViewState createState() => _PaymentWebViewState();
}

class _PaymentWebViewState extends State<PaymentWebView> {
  String? _paymentUrl;
  bool _isLoading = false;
  
  @override
  void initState() {
    super.initState();
    print('PaymentWebView Ï¥àÍ∏∞Ìôî');
    print('name: ${widget.name}');
    print('amount: ${widget.amount}');
    print('buyerEmail: ${widget.buyerEmail}');
    print('buyerName: ${widget.buyerName}');
    
    // Í≤∞Ï†ú URL ÏÉùÏÑ±
    _generatePaymentUrl();
  }

  void _generatePaymentUrl() {
    final merchantUid = 'mid_${DateTime.now().millisecondsSinceEpoch}';
    final paymentUrl = 'https://example.com/payment/$merchantUid?amount=${widget.amount}&name=${Uri.encodeComponent(widget.name)}&email=${Uri.encodeComponent(widget.buyerEmail)}&buyer=${Uri.encodeComponent(widget.buyerName)}';
    
    setState(() {
      _paymentUrl = paymentUrl;
    });
    
    print('Í≤∞Ï†ú URL ÏÉùÏÑ±: $paymentUrl');
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Í≤∞Ï†ú'),
        backgroundColor: Colors.blue,
        foregroundColor: Colors.white,
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            // Í≤∞Ï†ú Ï†ïÎ≥¥ Ïπ¥Îìú
            Card(
              elevation: 4,
              child: Padding(
                padding: const EdgeInsets.all(20),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text(
                      'üí≥ Í≤∞Ï†ú Ï†ïÎ≥¥',
                      style: TextStyle(
                        fontSize: 24,
                        fontWeight: FontWeight.bold,
                        color: Colors.blue,
                      ),
                    ),
                    const SizedBox(height: 20),
                    _buildInfoRow('ÏÉÅÌíàÎ™Ö', widget.name),
                    _buildInfoRow('Íµ¨Îß§Ïûê', widget.buyerName),
                    _buildInfoRow('Ïù¥Î©îÏùº', widget.buyerEmail),
                    _buildInfoRow('Í≤∞Ï†ú Í∏àÏï°', '${widget.amount.toString().replaceAllMapped(
                      RegExp(r'(\d{1,3})(?=(\d{3})+(?!\d))'),
                      (Match m) => '${m[1]},'
                    )}Ïõê'),
                  ],
                ),
              ),
            ),
            
            const SizedBox(height: 20),
            
            // Í≤∞Ï†ú Î∞©Î≤ï ÏÑ†ÌÉù
            Card(
              elevation: 4,
              child: Padding(
                padding: const EdgeInsets.all(20),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text(
                      'Í≤∞Ï†ú Î∞©Î≤ï ÏÑ†ÌÉù',
                      style: TextStyle(
                        fontSize: 20,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(height: 15),
                    _buildPaymentMethodButton(
                      'Ïã†Ïö©Ïπ¥Îìú',
                      Icons.credit_card,
                      Colors.blue,
                      () => _launchPayment('card'),
                    ),
                    const SizedBox(height: 10),
                    _buildPaymentMethodButton(
                      'Í≥ÑÏ¢åÏù¥Ï≤¥',
                      Icons.account_balance,
                      Colors.green,
                      () => _launchPayment('trans'),
                    ),
                    const SizedBox(height: 10),
                    _buildPaymentMethodButton(
                      'Í∞ÄÏÉÅÍ≥ÑÏ¢å',
                      Icons.account_balance_wallet,
                      Colors.orange,
                      () => _launchPayment('vbank'),
                    ),
                    const SizedBox(height: 10),
                    _buildPaymentMethodButton(
                      'Ìú¥ÎåÄÌè∞',
                      Icons.phone_android,
                      Colors.purple,
                      () => _launchPayment('phone'),
                    ),
                  ],
                ),
              ),
            ),
            
            const SizedBox(height: 20),
            
            // QR ÏΩîÎìú ÏÑπÏÖò
            if (_paymentUrl != null) ...[
              Card(
                elevation: 4,
                child: Padding(
                  padding: const EdgeInsets.all(20),
                  child: Column(
                    children: [
                      const Text(
                        'QR ÏΩîÎìúÎ°ú Í≤∞Ï†úÌïòÍ∏∞',
                        style: TextStyle(
                          fontSize: 20,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      const SizedBox(height: 10),
                      const Text(
                        'Îã§Î•∏ Í∏∞Í∏∞ÏóêÏÑú QR ÏΩîÎìúÎ•º Ïä§Ï∫îÌïòÏó¨ Í≤∞Ï†úÎ•º ÏßÑÌñâÌï† Ïàò ÏûàÏäµÎãàÎã§.',
                        textAlign: TextAlign.center,
                        style: TextStyle(color: Colors.grey),
                      ),
                      const SizedBox(height: 20),
                      QrImageView(
                        data: _paymentUrl!,
                        version: QrVersions.auto,
                        size: 200.0,
                      ),
                      const SizedBox(height: 20),
                      ElevatedButton.icon(
                        onPressed: () => _launchPayment('qr'),
                        icon: const Icon(Icons.qr_code),
                        label: const Text('QR ÏΩîÎìúÎ°ú Í≤∞Ï†ú'),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.green,
                          foregroundColor: Colors.white,
                          padding: const EdgeInsets.symmetric(horizontal: 30, vertical: 15),
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ],
            
            const SizedBox(height: 20),
            
            // Ïô∏Î∂Ä Î∏åÎùºÏö∞Ï†ÄÎ°ú Í≤∞Ï†ú
            Card(
              elevation: 4,
              child: Padding(
                padding: const EdgeInsets.all(20),
                child: Column(
                  children: [
                    const Text(
                      'Ïô∏Î∂Ä Î∏åÎùºÏö∞Ï†ÄÎ°ú Í≤∞Ï†ú',
                      style: TextStyle(
                        fontSize: 20,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(height: 10),
                    const Text(
                      'Í∏∞Î≥∏ Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú Í≤∞Ï†ú ÌéòÏù¥ÏßÄÎ•º Ïó¥Ïñ¥ Í≤∞Ï†úÎ•º ÏßÑÌñâÌï©ÎãàÎã§.',
                      textAlign: TextAlign.center,
                      style: TextStyle(color: Colors.grey),
                    ),
                    const SizedBox(height: 20),
                    ElevatedButton.icon(
                      onPressed: _isLoading ? null : () => _launchExternalBrowser(),
                      icon: _isLoading 
                        ? const SizedBox(
                            width: 20,
                            height: 20,
                            child: CircularProgressIndicator(strokeWidth: 2),
                          )
                        : const Icon(Icons.open_in_browser),
                      label: Text(_isLoading ? 'Î°úÎî© Ï§ë...' : 'Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú Í≤∞Ï†ú'),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.blue,
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(horizontal: 30, vertical: 15),
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildInfoRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(
            '$label:',
            style: const TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.w500,
            ),
          ),
          Text(
            value,
            style: const TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.bold,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildPaymentMethodButton(String title, IconData icon, Color color, VoidCallback onPressed) {
    return SizedBox(
      width: double.infinity,
      child: ElevatedButton.icon(
        onPressed: onPressed,
        icon: Icon(icon, color: Colors.white),
        label: Text(
          title,
          style: const TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.bold,
            color: Colors.white,
          ),
        ),
        style: ElevatedButton.styleFrom(
          backgroundColor: color,
          padding: const EdgeInsets.symmetric(vertical: 15),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(8),
          ),
        ),
      ),
    );
  }

  void _launchPayment(String method) async {
    if (_paymentUrl == null) return;
    
    setState(() {
      _isLoading = true;
    });
    
    try {
      // Í≤∞Ï†ú Î∞©Î≤ïÏóê Îî∞Î•∏ URL ÏàòÏ†ï
      String paymentUrl = _paymentUrl!;
      if (method != 'qr') {
        paymentUrl += '&method=$method';
      }
      
      final uri = Uri.parse(paymentUrl);
      if (await canLaunchUrl(uri)) {
        await launchUrl(uri, mode: LaunchMode.externalApplication);
        print('Í≤∞Ï†ú ÌéòÏù¥ÏßÄ Ïó¥Í∏∞ ÏÑ±Í≥µ: $paymentUrl');
        
        // Í≤∞Ï†ú ÏôÑÎ£å ÏïàÎÇ¥
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Í≤∞Ï†ú ÌéòÏù¥ÏßÄÍ∞Ä Ïó¥Î†∏ÏäµÎãàÎã§. Í≤∞Ï†úÎ•º ÏôÑÎ£åÌïú ÌõÑ Ïï±ÏúºÎ°ú ÎèåÏïÑÏôÄÏ£ºÏÑ∏Ïöî.'),
              backgroundColor: Colors.blue,
              duration: Duration(seconds: 3),
            ),
          );
        }
      } else {
        print('Í≤∞Ï†ú ÌéòÏù¥ÏßÄ Ïó¥Í∏∞ Ïã§Ìå®');
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Í≤∞Ï†ú ÌéòÏù¥ÏßÄÎ•º Ïó¥ Ïàò ÏóÜÏäµÎãàÎã§.'),
              backgroundColor: Colors.red,
            ),
          );
        }
      }
    } catch (e) {
      print('Í≤∞Ï†ú ÌéòÏù¥ÏßÄ Ïó¥Í∏∞ Ïò§Î•ò: $e');
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() {
          _isLoading = false;
        });
      }
    }
  }

  void _launchExternalBrowser() async {
    if (_paymentUrl == null) return;
    
    setState(() {
      _isLoading = true;
    });
    
    try {
      // Ïã§Ï†ú Í≤∞Ï†ú ÏÑúÎπÑÏä§ URLÎ°ú Î≥ÄÍ≤Ω (Ïòà: ÏïÑÏûÑÌè¨Ìä∏, ÌÜ†Ïä§ÌéòÏù¥Î®ºÏ∏† Îì±)
      final paymentServiceUrl = 'https://payment.example.com/pay?' + 
        'merchant_uid=${DateTime.now().millisecondsSinceEpoch}' +
        '&amount=${widget.amount}' +
        '&name=${Uri.encodeComponent(widget.name)}' +
        '&buyer_email=${Uri.encodeComponent(widget.buyerEmail)}' +
        '&buyer_name=${Uri.encodeComponent(widget.buyerName)}';
      
      final uri = Uri.parse(paymentServiceUrl);
      if (await canLaunchUrl(uri)) {
        await launchUrl(uri, mode: LaunchMode.externalApplication);
        print('Ïô∏Î∂Ä Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú Í≤∞Ï†ú ÌéòÏù¥ÏßÄ Ïó¥Í∏∞ ÏÑ±Í≥µ');
        
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú Í≤∞Ï†ú ÌéòÏù¥ÏßÄÍ∞Ä Ïó¥Î†∏ÏäµÎãàÎã§.'),
              backgroundColor: Colors.green,
              duration: Duration(seconds: 3),
            ),
          );
        }
      } else {
        print('Ïô∏Î∂Ä Î∏åÎùºÏö∞Ï†Ä Ïó¥Í∏∞ Ïã§Ìå®');
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Î∏åÎùºÏö∞Ï†ÄÎ•º Ïó¥ Ïàò ÏóÜÏäµÎãàÎã§.'),
              backgroundColor: Colors.red,
            ),
          );
        }
      }
    } catch (e) {
      print('Ïô∏Î∂Ä Î∏åÎùºÏö∞Ï†Ä Ïó¥Í∏∞ Ïò§Î•ò: $e');
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() {
          _isLoading = false;
        });
      }
    }
  }
} 