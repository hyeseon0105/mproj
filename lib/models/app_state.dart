import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';
<<<<<<< HEAD
=======
import '../services/user_settings_service.dart';
import '../services/diary_service.dart';
>>>>>>> origin/main

enum Emotion { fruit, animal, shape, weather }

class EmotionData {
  final Emotion emotion;
  final String emoji;
  final String? entry;
  final List<String>? images;

  EmotionData({
    required this.emotion,
    required this.emoji,
    this.entry,
    this.images,
  });

  Map<String, dynamic> toJson() {
    return {
      'emotion': emotion.name,
      'emoji': emoji,
      'entry': entry,
      'images': images,
    };
  }

  factory EmotionData.fromJson(Map<String, dynamic> json) {
    return EmotionData(
      emotion: Emotion.values.firstWhere((e) => e.name == json['emotion']),
      emoji: json['emoji'],
      entry: json['entry'],
      images: json['images']?.cast<String>(),
    );
  }
}

enum CurrentView { calendar, entry, mypage }

<<<<<<< HEAD
enum UserSubscription { normal, premium }
=======

>>>>>>> origin/main

class AppState extends ChangeNotifier {
  bool _isAuthenticated = false;
  CurrentView _currentView = CurrentView.calendar;
  String _selectedDate = '';
<<<<<<< HEAD
  UserSubscription _userSubscription = UserSubscription.normal;
  DateTime? _userBirthday;
  bool _emoticonEnabled = true;
  String _userName = 'ÏÇ¨Ïö©Ïûê';
  String _userEmail = '';
  String _accessToken = '';
  Emotion _selectedEmoticonCategory = Emotion.shape;
  
  final Map<String, EmotionData> _emotionData = {
    '2024-02-01': EmotionData(emotion: Emotion.fruit, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/fruit%2Fneutral_fruit-removebg-preview.png?alt=media&token=9bdea06c-13e6-4c59-b961-1424422a3c39'),
    '2024-02-02': EmotionData(emotion: Emotion.animal, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/animal%2Fneutral_animal-removebg-preview.png?alt=media&token=f884e38d-5d8c-4d4a-bb62-a47a198d384f'),
    '2024-02-03': EmotionData(emotion: Emotion.shape, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/shape%2Fneutral_shape-removebg-preview.png?alt=media&token=02e85132-3a83-4257-8c1e-d2e478c7fcf5'),
    '2024-02-04': EmotionData(emotion: Emotion.weather, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/wheather%2Fneutral_weather-removebg-preview.png?alt=media&token=57ad1adf-baa6-4b79-96f5-066a4ec3358f'),
    '2024-02-05': EmotionData(emotion: Emotion.fruit, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/fruit%2Fneutral_fruit-removebg-preview.png?alt=media&token=9bdea06c-13e6-4c59-b961-1424422a3c39'),
    '2024-02-06': EmotionData(emotion: Emotion.animal, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/animal%2Fneutral_animal-removebg-preview.png?alt=media&token=f884e38d-5d8c-4d4a-bb62-a47a198d384f'),
    '2024-02-07': EmotionData(emotion: Emotion.shape, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/shape%2Fneutral_shape-removebg-preview.png?alt=media&token=02e85132-3a83-4257-8c1e-d2e478c7fcf5'),
    '2024-02-08': EmotionData(emotion: Emotion.weather, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/wheather%2Fneutral_weather-removebg-preview.png?alt=media&token=57ad1adf-baa6-4b79-96f5-066a4ec3358f'),
    '2024-02-09': EmotionData(emotion: Emotion.fruit, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/fruit%2Fneutral_fruit-removebg-preview.png?alt=media&token=9bdea06c-13e6-4c59-b961-1424422a3c39'),
    '2024-02-10': EmotionData(emotion: Emotion.animal, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/animal%2Fneutral_animal-removebg-preview.png?alt=media&token=f884e38d-5d8c-4d4a-bb62-a47a198d384f'),
    '2024-02-11': EmotionData(emotion: Emotion.shape, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/shape%2Fneutral_shape-removebg-preview.png?alt=media&token=02e85132-3a83-4257-8c1e-d2e478c7fcf5'),
    '2024-02-12': EmotionData(emotion: Emotion.weather, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/wheather%2Fneutral_weather-removebg-preview.png?alt=media&token=57ad1adf-baa6-4b79-96f5-066a4ec3358f'),
    '2024-02-13': EmotionData(emotion: Emotion.fruit, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/fruit%2Fneutral_fruit-removebg-preview.png?alt=media&token=9bdea06c-13e6-4c59-b961-1424422a3c39'),
    '2024-02-14': EmotionData(emotion: Emotion.animal, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/animal%2Fneutral_animal-removebg-preview.png?alt=media&token=f884e38d-5d8c-4d4a-bb62-a47a198d384f'),
    '2024-02-15': EmotionData(emotion: Emotion.shape, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/shape%2Fneutral_shape-removebg-preview.png?alt=media&token=02e85132-3a83-4257-8c1e-d2e478c7fcf5'),
    '2024-02-16': EmotionData(emotion: Emotion.weather, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/wheather%2Fneutral_weather-removebg-preview.png?alt=media&token=57ad1adf-baa6-4b79-96f5-066a4ec3358f'),
    '2024-02-17': EmotionData(emotion: Emotion.fruit, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/fruit%2Fneutral_fruit-removebg-preview.png?alt=media&token=9bdea06c-13e6-4c59-b961-1424422a3c39'),
    '2024-02-18': EmotionData(emotion: Emotion.animal, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/animal%2Fneutral_animal-removebg-preview.png?alt=media&token=f884e38d-5d8c-4d4a-bb62-a47a198d384f'),
    '2024-02-19': EmotionData(emotion: Emotion.shape, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/shape%2Fneutral_shape-removebg-preview.png?alt=media&token=02e85132-3a83-4257-8c1e-d2e478c7fcf5'),
    '2024-02-20': EmotionData(emotion: Emotion.weather, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/wheather%2Fneutral_weather-removebg-preview.png?alt=media&token=57ad1adf-baa6-4b79-96f5-066a4ec3358f'),
    '2024-02-21': EmotionData(emotion: Emotion.fruit, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/fruit%2Fneutral_fruit-removebg-preview.png?alt=media&token=9bdea06c-13e6-4c59-b961-1424422a3c39'),
    '2024-02-22': EmotionData(emotion: Emotion.animal, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/animal%2Fneutral_animal-removebg-preview.png?alt=media&token=f884e38d-5d8c-4d4a-bb62-a47a198d384f'),
    '2024-02-23': EmotionData(emotion: Emotion.shape, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/shape%2Fneutral_shape-removebg-preview.png?alt=media&token=02e85132-3a83-4257-8c1e-d2e478c7fcf5'),
    '2024-02-24': EmotionData(emotion: Emotion.weather, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/wheather%2Fneutral_weather-removebg-preview.png?alt=media&token=57ad1adf-baa6-4b79-96f5-066a4ec3358f'),
    '2024-02-25': EmotionData(emotion: Emotion.fruit, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/fruit%2Fneutral_fruit-removebg-preview.png?alt=media&token=9bdea06c-13e6-4c59-b961-1424422a3c39'),
    '2024-02-26': EmotionData(emotion: Emotion.animal, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/animal%2Fneutral_animal-removebg-preview.png?alt=media&token=f884e38d-5d8c-4d4a-bb62-a47a198d384f'),
    '2024-02-27': EmotionData(emotion: Emotion.shape, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/shape%2Fneutral_shape-removebg-preview.png?alt=media&token=02e85132-3a83-4257-8c1e-d2e478c7fcf5'),
    '2024-02-28': EmotionData(emotion: Emotion.weather, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/wheather%2Fneutral_weather-removebg-preview.png?alt=media&token=57ad1adf-baa6-4b79-96f5-066a4ec3358f'),
    '2024-02-29': EmotionData(emotion: Emotion.fruit, emoji: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/fruit%2Fneutral_fruit-removebg-preview.png?alt=media&token=9bdea06c-13e6-4c59-b961-1424422a3c39'),
=======

  DateTime? _userBirthday;
  bool _emoticonEnabled = true;
  bool _voiceEnabled = true;
  int _voiceVolume = 50;
  Map<String, List<String>> _emoticonCategories = {
    'shape': ['‚≠ê', 'üî∂', 'üî∑', '‚ö´', 'üî∫'],
    'fruit': ['üçé', 'üçä', 'üçå', 'üçá', 'üçì'],
    'animal': ['üê∂', 'üê±', 'üê∞', 'üê∏', 'üêº'],
    'weather': ['‚òÄÔ∏è', 'üåßÔ∏è', '‚õàÔ∏è', 'üåà', '‚ùÑÔ∏è']
  };
  String _lastSelectedEmotionCategory = 'shape'; // ÎßàÏßÄÎßâ ÏÑ†ÌÉùÎêú Ïπ¥ÌÖåÍ≥†Î¶¨
  
  final Map<String, EmotionData> _emotionData = {
    '2024-02-01': EmotionData(emotion: Emotion.fruit, emoji: 'üçé'),
    '2024-02-02': EmotionData(emotion: Emotion.animal, emoji: 'üê∂'),
    '2024-02-03': EmotionData(emotion: Emotion.shape, emoji: '‚≠ê'),
    '2024-02-04': EmotionData(emotion: Emotion.weather, emoji: '‚òÄÔ∏è'),
    '2024-02-05': EmotionData(emotion: Emotion.fruit, emoji: 'üçä'),
    '2024-02-06': EmotionData(emotion: Emotion.animal, emoji: 'üê±'),
    '2024-02-07': EmotionData(emotion: Emotion.shape, emoji: 'üî∂'),
    '2024-02-08': EmotionData(emotion: Emotion.weather, emoji: 'üåßÔ∏è'),
    '2024-02-09': EmotionData(emotion: Emotion.fruit, emoji: 'üçå'),
    '2024-02-10': EmotionData(emotion: Emotion.animal, emoji: 'üê∞'),
    '2024-02-11': EmotionData(emotion: Emotion.shape, emoji: 'üî∑'),
    '2024-02-12': EmotionData(emotion: Emotion.weather, emoji: '‚õàÔ∏è'),
    '2024-02-13': EmotionData(emotion: Emotion.fruit, emoji: 'üçá'),
    '2024-02-14': EmotionData(emotion: Emotion.animal, emoji: 'üê∏'),
    '2024-02-15': EmotionData(emotion: Emotion.shape, emoji: '‚ö´'),
    '2024-02-16': EmotionData(emotion: Emotion.weather, emoji: 'üåà'),
    '2024-02-17': EmotionData(emotion: Emotion.fruit, emoji: 'üçì'),
    '2024-02-18': EmotionData(emotion: Emotion.animal, emoji: 'üêº'),
    '2024-02-19': EmotionData(emotion: Emotion.shape, emoji: 'üî∫'),
    '2024-02-20': EmotionData(emotion: Emotion.weather, emoji: '‚ùÑÔ∏è'),
    '2024-02-21': EmotionData(emotion: Emotion.fruit, emoji: 'ü•ù'),
    '2024-02-22': EmotionData(emotion: Emotion.animal, emoji: 'ü¶ä'),
    '2024-02-23': EmotionData(emotion: Emotion.shape, emoji: 'üåü'),
    '2024-02-24': EmotionData(emotion: Emotion.weather, emoji: 'üå§Ô∏è'),
    '2024-02-25': EmotionData(emotion: Emotion.fruit, emoji: 'üçë'),
    '2024-02-26': EmotionData(emotion: Emotion.animal, emoji: 'üêª'),
    '2024-02-27': EmotionData(emotion: Emotion.shape, emoji: '‚ú®'),
    '2024-02-28': EmotionData(emotion: Emotion.weather, emoji: '‚õÖ'),
    '2024-02-29': EmotionData(emotion: Emotion.fruit, emoji: 'ü•≠'),
>>>>>>> origin/main
  };

  static const Map<Emotion, String> emotionEmojis = {
    Emotion.fruit: 'üçé',
    Emotion.animal: 'üê∂',
    Emotion.shape: '‚≠ê',
    Emotion.weather: '‚òÄÔ∏è',
  };

  // Getters
  bool get isAuthenticated => _isAuthenticated;
  CurrentView get currentView => _currentView;
  String get selectedDate => _selectedDate;
<<<<<<< HEAD
  UserSubscription get userSubscription => _userSubscription;
  DateTime? get userBirthday => _userBirthday;
  bool get emoticonEnabled => _emoticonEnabled;
  Map<String, EmotionData> get emotionData => Map.unmodifiable(_emotionData);
  String get userName => _userName;
  String get userEmail => _userEmail;
  String get accessToken => _accessToken;
  Emotion get selectedEmoticonCategory => _selectedEmoticonCategory;

  AppState() {
    _loadEmoticonSetting();
=======

  DateTime? get userBirthday => _userBirthday;
  bool get emoticonEnabled => _emoticonEnabled;
  bool get voiceEnabled => _voiceEnabled;
  int get voiceVolume => _voiceVolume;
  Map<String, List<String>> get emoticonCategories => Map.unmodifiable(_emoticonCategories);
  String get lastSelectedEmotionCategory => _lastSelectedEmotionCategory;
  Map<String, EmotionData> get emotionData => Map.unmodifiable(_emotionData);

  AppState() {
    _loadEmoticonSetting();
    _checkAuthStatus();
  }
  
  void _checkAuthStatus() async {
    final prefs = await SharedPreferences.getInstance();
    final token = prefs.getString('access_token');
    if (token != null) {
      setAuthenticated(true);
      // ÌÜ†ÌÅ∞Ïù¥ ÏûàÏùÑ ÎïåÎßå ÏÑ§Ï†ï Î°úÎìú
      await _loadUserSettings();
    }
>>>>>>> origin/main
  }

  void _loadEmoticonSetting() async {
    final prefs = await SharedPreferences.getInstance();
    _emoticonEnabled = prefs.getBool('emoticonEnabled') ?? true;
    notifyListeners();
  }

<<<<<<< HEAD
  void setAuthenticated(bool value) {
    _isAuthenticated = value;
    notifyListeners();
=======
  // ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï Î°úÎìú
  Future<void> _loadUserSettings() async {
    try {
      final settings = await UserSettingsService.getUserSettings();
      _emoticonEnabled = settings['emoticon_enabled'] ?? true;
      _voiceEnabled = settings['voice_enabled'] ?? true;
      _voiceVolume = settings['voice_volume'] ?? 50;
      _emoticonCategories = Map<String, List<String>>.from(
        settings['emoticon_categories'] ?? UserSettingsService.defaultSettings['emoticon_categories']
      );
      _lastSelectedEmotionCategory = settings['last_selected_emotion_category'] ?? 'shape';
      notifyListeners();
    } catch (e) {
      print('ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï Î°úÎìú Ïã§Ìå®: $e');
      // Í∏∞Î≥∏ ÏÑ§Ï†ï ÏÇ¨Ïö©
    }
  }

  void setAuthenticated(bool value) {
    _isAuthenticated = value;
    if (value) {
      // Î°úÍ∑∏Ïù∏ Ïãú ÏÑ§Ï†ï Î°úÎìú Î∞è ÏùºÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú (ÎπÑÎèôÍ∏∞Î°ú Ï≤òÎ¶¨)
      _loadUserSettings().then((_) {
        loadDiaryData().then((_) {
          notifyListeners();
        });
      });
    } else {
      notifyListeners();
    }
>>>>>>> origin/main
  }

  void setCurrentView(CurrentView view) {
    _currentView = view;
    notifyListeners();
  }

  void setSelectedDate(String date) {
    _selectedDate = date;
    notifyListeners();
  }

<<<<<<< HEAD
  void setUserSubscription(UserSubscription subscription) {
    _userSubscription = subscription;
    notifyListeners();
  }
=======

>>>>>>> origin/main

  void setUserBirthday(DateTime? birthday) {
    _userBirthday = birthday;
    notifyListeners();
  }

<<<<<<< HEAD
  void setEmoticonEnabled(bool enabled) async {
    _emoticonEnabled = enabled;
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool('emoticonEnabled', enabled);
    notifyListeners();
  }

  void saveDiary(String entry, Emotion emotion, List<String>? images) {
    final Map<Emotion, String> firebaseEmojis = {
      Emotion.fruit: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/fruit%2Fneutral_fruit-removebg-preview.png?alt=media&token=9bdea06c-13e6-4c59-b961-1424422a3c39',
      Emotion.animal: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/animal%2Fneutral_animal-removebg-preview.png?alt=media&token=f884e38d-5d8c-4d4a-bb62-a47a198d384f',
      Emotion.shape: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/shape%2Fneutral_shape-removebg-preview.png?alt=media&token=02e85132-3a83-4257-8c1e-d2e478c7fcf5',
      Emotion.weather: 'https://firebasestorage.googleapis.com/v0/b/diary-3bbf7.firebasestorage.app/o/wheather%2Fneutral_weather-removebg-preview.png?alt=media&token=57ad1adf-baa6-4b79-96f5-066a4ec3358f',
    };
    
    _emotionData[_selectedDate] = EmotionData(
      emotion: emotion,
      emoji: firebaseEmojis[emotion]!,
=======
  // Ïù¥Î™®Ìã∞ÏΩò ÏÑ§Ï†ï ÏóÖÎç∞Ïù¥Ìä∏
  Future<void> setEmoticonEnabled(bool enabled) async {
    _emoticonEnabled = enabled;
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool('emoticonEnabled', enabled);
    
    try {
      await UserSettingsService.updateUserSettings(emoticonEnabled: enabled);
    } catch (e) {
      print('Ïù¥Î™®Ìã∞ÏΩò ÏÑ§Ï†ï ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: $e');
    }
    
    notifyListeners();
  }

  // ÏùåÏÑ± ÏÑ§Ï†ï ÏóÖÎç∞Ïù¥Ìä∏
  Future<void> setVoiceEnabled(bool enabled) async {
    _voiceEnabled = enabled;
    try {
      await UserSettingsService.updateUserSettings(voiceEnabled: enabled);
    } catch (e) {
      print('ÏùåÏÑ± ÏÑ§Ï†ï ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: $e');
    }
    notifyListeners();
  }

  // ÏùåÏÑ± Î≥ºÎ•® ÏÑ§Ï†ï ÏóÖÎç∞Ïù¥Ìä∏
  Future<void> setVoiceVolume(int volume) async {
    _voiceVolume = volume;
    try {
      await UserSettingsService.updateUserSettings(voiceVolume: volume);
    } catch (e) {
      print('ÏùåÏÑ± Î≥ºÎ•® ÏÑ§Ï†ï ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: $e');
    }
    notifyListeners();
  }

  // Ïù¥Î™®Ìã∞ÏΩò Ïπ¥ÌÖåÍ≥†Î¶¨ ÏóÖÎç∞Ïù¥Ìä∏
  Future<void> setEmoticonCategories(Map<String, List<String>> categories) async {
    _emoticonCategories = Map<String, List<String>>.from(categories);
    try {
      await UserSettingsService.updateEmoticonCategories(categories);
    } catch (e) {
      print('Ïù¥Î™®Ìã∞ÏΩò Ïπ¥ÌÖåÍ≥†Î¶¨ ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: $e');
    }
    notifyListeners();
  }

  // ÎßàÏßÄÎßâ ÏÑ†ÌÉùÎêú Ïù¥Î™®Ìã∞ÏΩò Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ§Ï†ï
  Future<void> setLastSelectedEmotionCategory(String category) async {
    _lastSelectedEmotionCategory = category;
    try {
      await UserSettingsService.updateUserSettings(
        lastSelectedEmotionCategory: category
      );
    } catch (e) {
      print('ÎßàÏßÄÎßâ ÏÑ†ÌÉùÎêú Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ÄÏû• Ïã§Ìå®: $e');
    }
    notifyListeners();
  }

  // ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî
  Future<void> resetUserSettings() async {
    try {
      final settings = await UserSettingsService.resetUserSettings();
      _emoticonEnabled = settings['emoticon_enabled'] ?? true;
      _voiceEnabled = settings['voice_enabled'] ?? true;
      _voiceVolume = settings['voice_volume'] ?? 50;
      _emoticonCategories = Map<String, List<String>>.from(
        settings['emoticon_categories'] ?? UserSettingsService.defaultSettings['emoticon_categories']
      );
      notifyListeners();
    } catch (e) {
      print('ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî Ïã§Ìå®: $e');
    }
  }

  // Ïù¥Î™®Ìã∞ÏΩò Ïπ¥ÌÖåÍ≥†Î¶¨Îßå Ï¥àÍ∏∞Ìôî
  Future<void> resetEmoticonCategories() async {
    try {
      final defaultCategories = UserSettingsService.defaultSettings['emoticon_categories'] as Map<String, List<String>>;
      _emoticonCategories = Map<String, List<String>>.from(defaultCategories);
      _lastSelectedEmotionCategory = 'shape';
      
      await UserSettingsService.updateUserSettings(
        emoticonCategories: defaultCategories,
        lastSelectedEmotionCategory: 'shape'
      );
      notifyListeners();
    } catch (e) {
      print('Ïù¥Î™®Ìã∞ÏΩò Ïπ¥ÌÖåÍ≥†Î¶¨ Ï¥àÍ∏∞Ìôî Ïã§Ìå®: $e');
    }
  }

  void saveDiary(String entry, Emotion emotion, List<String>? images) {
    _emotionData[_selectedDate] = EmotionData(
      emotion: emotion,
      emoji: emotionEmojis[emotion]!,
>>>>>>> origin/main
      entry: entry,
      images: images,
    );
    notifyListeners();
  }

<<<<<<< HEAD
=======
  // ÏÑúÎ≤ÑÏóêÏÑú ÏùºÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
  Future<void> loadDiaryData() async {
    if (!_isAuthenticated) return;
    
    try {
      final diaryService = DiaryService();
      final posts = await diaryService.getAllDiaries();
      
      // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
      _emotionData.clear();
      
      // ÏÑúÎ≤Ñ Îç∞Ïù¥ÌÑ∞Î°ú ÏóÖÎç∞Ïù¥Ìä∏
      for (final post in posts) {
        final emotion = _analyzeEmotion(post['content']);
        _emotionData[post['id']] = EmotionData(
          emotion: emotion,
          emoji: emotionEmojis[emotion]!,
          entry: post['content'],
          images: List<String>.from(post['images'].map((img) => img['file_path'])),
        );
      }
      notifyListeners();
    } catch (e) {
      print('ÏùºÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®: $e');
    }
  }

  // Í∞êÏ†ï Î∂ÑÏÑù (Í∞ÑÎã®Ìïú ÌÇ§ÏõåÎìú Í∏∞Î∞ò)
  Emotion _analyzeEmotion(String text) {
    final fruitWords = ['Í≥ºÏùº', 'ÏÇ¨Í≥º', 'Î∞îÎÇòÎÇò', 'Îî∏Í∏∞', 'Ìè¨ÎèÑ', 'ÎßõÏûà', 'Îã¨ÏΩ§', 'ÏÉÅÌÅº'];
    final animalWords = ['ÎèôÎ¨º', 'Í∞ïÏïÑÏßÄ', 'Í≥†ÏñëÏù¥', 'ÏÉà', 'ÌÜ†ÎÅº', 'Í∑ÄÏó¨', 'Ïï†ÏôÑÎèôÎ¨º', 'Î∞òÎ†§ÎèôÎ¨º'];
    final shapeWords = ['Î™®Ïñë', 'Ïõê', 'ÏÇ¨Í∞ÅÌòï', 'ÏÇºÍ∞ÅÌòï', 'Î≥Ñ', 'ÎèÑÌòï', 'Í∑∏Î¶º', 'ÎîîÏûêÏù∏'];
    final weatherWords = ['ÎÇ†Ïî®', 'ÎßëÏùÄ', 'ÎπÑ', 'Îàà', 'Íµ¨Î¶Ñ', 'ÌñáÎπõ', 'Î∞îÎûå', 'Í∏∞Ïò®'];

    final lowerText = text.toLowerCase();
    
    if (fruitWords.any((word) => lowerText.contains(word))) return Emotion.fruit;
    if (animalWords.any((word) => lowerText.contains(word))) return Emotion.animal;
    if (shapeWords.any((word) => lowerText.contains(word))) return Emotion.shape;
    if (weatherWords.any((word) => lowerText.contains(word))) return Emotion.weather;
    
    return Emotion.fruit; // default
  }

>>>>>>> origin/main
  void handleDateSelect(String date) {
    print('AppState.handleDateSelect called: $date'); // ÎîîÎ≤ÑÍπÖÏö© Î°úÍ∑∏
    setSelectedDate(date);
    print('Selected date set to: $date'); // ÎîîÎ≤ÑÍπÖÏö© Î°úÍ∑∏
    setCurrentView(CurrentView.entry);
    print('Current view set to: entry'); // ÎîîÎ≤ÑÍπÖÏö© Î°úÍ∑∏
  }

  void handleBackToCalendar() {
    setCurrentView(CurrentView.calendar);
  }

  void handleSettingsClick() {
    setCurrentView(CurrentView.mypage);
  }

<<<<<<< HEAD
  void setUserInfo(String name, String email, String token, {String? birthday}) {
    print('AppState.setUserInfo Ìò∏Ï∂úÎê®: name=$name, email=$email, birthday=$birthday'); // ÎîîÎ≤ÑÍπÖÏö© Î°úÍ∑∏
    print('Ïù¥Ï†Ñ ÏÇ¨Ïö©ÏûêÎ™Ö: $_userName'); // ÎîîÎ≤ÑÍπÖÏö© Î°úÍ∑∏
    _userName = name;
    _userEmail = email;
    _accessToken = token;
    if (birthday != null) {
      try {
        _userBirthday = DateTime.parse(birthday);
      } catch (e) {
        print('ÏÉùÏùº ÌååÏã± Ïò§Î•ò: $e');
        _userBirthday = null;
      }
    }
    print('ÏÑ§Ï†ïÎêú ÏÇ¨Ïö©ÏûêÎ™Ö: $_userName'); // ÎîîÎ≤ÑÍπÖÏö© Î°úÍ∑∏
    notifyListeners();
  }

  void setSelectedEmoticonCategory(Emotion category) {
    _selectedEmoticonCategory = category;
    notifyListeners();
  }

=======
>>>>>>> origin/main
  void handleLogin() {
    setAuthenticated(true);
  }

<<<<<<< HEAD
  void handleLogout() {
    setAuthenticated(false);
    setCurrentView(CurrentView.calendar);
    _userName = 'ÏÇ¨Ïö©Ïûê';
    _userEmail = '';
    _accessToken = '';
    notifyListeners();
=======
  void handleLogout() async {
    // Ï†ÄÏû•Îêú ÌÜ†ÌÅ∞Í≥º ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏÇ≠Ï†ú
    final prefs = await SharedPreferences.getInstance();
    await prefs.remove('access_token');
    await prefs.remove('user_id');
    await prefs.remove('username');
    await prefs.remove('email');
    await prefs.remove('birthday');
    
    // ÏùºÍ∏∞ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
    _emotionData.clear();
    
    setAuthenticated(false);
    setCurrentView(CurrentView.calendar);
>>>>>>> origin/main
  }
} 